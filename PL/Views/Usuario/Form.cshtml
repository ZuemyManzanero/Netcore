@model ML.Usuario
@{
    ViewBag.Title = "Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Usuarios</h2>
            <h5>Ingrese los datos del Usuario:</h5>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            @using (Html.BeginForm("Form", "Usuario", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                <div class="form-horizontal">
                    <div class="row">
                        <div class="col-md-3" style="display:none;">
                            @Html.LabelFor(model => model.IdUsuario, new { @class = "hidden" })
                            @Html.TextBoxFor(model => model.IdUsuario, new { @class = "hidden form-control", autocomplete = "off"})
                            @Html.ValidationMessageFor(model => model.IdUsuario)
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            @Html.Label("UserName") 
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                            @Html.TextBoxFor(model => model.UserName, new { @class = "form-control", @id = "txtUserName", @onkeypress = "return SoloLetras(event,'lblErrorUserName')"})
                            @Html.ValidationMessageFor(model => model.UserName, null, new{@class="text-danger"})
                            <label id="lblErrorUserName"></label>
                        </div>
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Nombre") 
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                            @Html.TextBoxFor(model => model.Nombre, new { @class = "form-control", @id = "txtNombre", @onkeypress = "return SoloLetras(event,'lblErrorNombre')"})
                            @Html.ValidationMessageFor(model => model.Nombre, null, new{@class="text-danger"})
                            <label id="lblErrorNombre"></label>
                        </div>
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Apellido Paterno")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                            @Html.TextBoxFor(model => model.ApellidoPaterno, new { @class = "form-control", @id = "txtApellidoPaterno", @onkeypress = "return SoloLetras(event,'lblApellidoPaterno')"})
                            @Html.ValidationMessageFor(model => model.ApellidoPaterno, null, new{@class="text-danger"})
                            <label id="lblApellidoPaterno"></label>
                        </div>
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Apellido Materno")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                            @Html.TextBoxFor(model => model.ApellidoMaterno, new { @class = "form-control", @id = "txtApellidoMaterno",@onkeypress = "return SoloLetras(event,'lblApellidoMaterno')"})
                            @Html.ValidationMessageFor(model => model.ApellidoMaterno, null, new{@class="text-danger"})
                            <label id="lblApellidoMaterno"></label>
                        </div>
                        </div>
                        </div>
                    <div class="row">
                        <div class="col-md-3">
                            @Html.Label("Email")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                            @Html.TextBoxFor(model => model.Email, new { @class = "form-control", @id = "txtEmail", @onblur ="ValidarEmail()" })    
                            @Html.ValidationMessageFor(model => model.Email, "", new { @class = "text-danger" })
                            <label id="lblEmailError"></label>
                            </div>
                        </div>
                     <div class="col-md-3">
                            @Html.Label("Confirmacion Email")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                            @Html.TextBoxFor(model => model.Email, new { @class = "form-control", @id = "txtEmail2", @onblur ="CompararEmail()" })    
                            @Html.ValidationMessageFor(model => model.Email, "", new { @class = "text-danger" })
                            <label id="lblEmail"></label>
                            </div>
                      </div>
                       <div class="col-md-3">
                            @Html.Label("Password")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-file-lock2-fill"></i></span>
                            @Html.TextBoxFor(model => model.Password, new { @class = "form-control", @id = "txtPassword" })
                            @Html.ValidationMessageFor(model => model.Password, null, new{@class="text-danger"})                        
                            </div>
                       </div>
                        <div class="col-md-3">
                            @Html.Label("Confirmacion Password")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-file-lock2-fill"></i></span>
                            @Html.TextBoxFor(model => model.Password, new {@class = "form-control", @id = "txtPassword2", @onblur ="CompararPassword()"})
                            @Html.ValidationMessageFor(model => model.Password, null, new{@class="text-danger"})
                            <label id="lblPassword"></label>
                            </div>
                        </div>
                        </div>
                    <div class="row">
                            <div class="col-md-3">
                            @Html.LabelFor(model => model.Sexo, new { @class = "control-label" })
                            <br>
                            <input type="radio" value="Masculino"> MASCULINO 
                            <input type="radio" value="Femenino"> FEMENINO 
                            @Html.ValidationMessageFor(model => model.Sexo)
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Telefono") 
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-telephone-fill"></i></span>
                            @Html.TextBoxFor(model => model.Telefono, new { @class = "form-control", @id = "txtTelefono", @onkeypress = "return SoloNumeros(event,'lblTelefono')"})
                            @Html.ValidationMessageFor(model => model.Telefono, null, new{@class="text-danger"})
                            <label id="lblTelefono"></label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Celular") 
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-telephone-fill"></i></span>
                            @Html.TextBoxFor(model => model.Celular, new { @class = "form-control", @id = "txtCelular", @onkeypress = "return SoloNumeros(event,'lblCelular')"})
                            @Html.ValidationMessageFor(model => model.Celular, null, new{@class="text-danger"})
                            <label id="lblCelular"></label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Fecha de Nacimiento")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                            @Html.TextBoxFor(model => model.FechaNacimiento, new { @class = "form-control", @id = "txtFechaNacimiento"})
                            @Html.ValidationMessageFor(model => model.FechaNacimiento, null, new{@class="text-danger"})
                            </div>
                        </div>  
                        </div>
                    <div class="row">
                            <div class="col-md-3">
                        @Html.Label("Paises")
                        <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                        @Html.DropDownListFor(model => model.Direccion.Colonia.Municipio.Estado.Pais.IdPais, new SelectList(Model.Direccion.Colonia.Municipio.Estado.Pais.Paises, "IdPais", "Nombre"), "Selecciona un Pais", new { @class = "form-control", @id = "ddlPais" })
                        @Html.ValidationMessageFor(model => model.Direccion.Colonia.Municipio.Estado.Pais.IdPais, null, new{@class="text-danger"})
                        </div>
                    </div>
                    <div class="col-md-3">
                        @Html.Label("Estados")
                        <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                        @if (Model.Direccion.Colonia.Municipio.Estado.Estados == null)
                            {
                                @Html.DropDownListFor(model => model.Direccion.Colonia.Municipio.Estado.IdEstado, new SelectList(string.Empty, "Value", "Text"), "Selecciona un Estado", new { @class = "form-control", @id = "ddlEstado" })
                                @Html.ValidationMessageFor(model => model.Direccion.Colonia.Municipio.Estado.IdEstado, null, new{@class="text-danger"})
                            }
                            else
                            {
                                @Html.DropDownListFor(model => model.Direccion.Colonia.Municipio.Estado.IdEstado, new SelectList(Model.Direccion.Colonia.Municipio.Estado.Estados, "IdEstado", "Nombre"), "Selecciona un Estado", new { @class = "form-control", @id = "ddlEstado" })
                                @Html.ValidationMessageFor(model => model.Direccion.Colonia.Municipio.Estado.IdEstado, null, new{@class="text-danger"})
                            }
                        </div>
                    </div>
                    <div class="col-md-3">
                        @Html.Label("Municipios") 
                        <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                        @if (Model.Direccion.Colonia.Municipio.Municipios == null)
                            {
                                @Html.DropDownListFor(model => model.Direccion.Colonia.Municipio.IdMunicipio, new SelectList(string.Empty, "Value", "Text"), "Selecciona un Municipio", new { @class = "form-control", @id = "ddlMunicipio" })
                                @Html.ValidationMessageFor(model => model.Direccion.Colonia.Municipio.IdMunicipio, null, new{@class="text-danger"})
                            }
                            else
                            {
                                @Html.DropDownListFor(model => model.Direccion.Colonia.Municipio.IdMunicipio, new SelectList(Model.Direccion.Colonia.Municipio.Municipios, "IdMunicipio", "Nombre"), "Selecciona un Municipio", new { @class = "form-control", @id = "ddlMunicipio" })
                                @Html.ValidationMessageFor(model => model.Direccion.Colonia.Municipio.IdMunicipio, null, new{@class="text-danger"})
                            }
                        </div>
                    </div>

                         <div class="col-md-3">
                        @Html.Label("Colonias") 
                        <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                        @if (Model.Direccion.Colonia.Colonias == null)
                            {
                                @Html.DropDownListFor(model => model.Direccion.Colonia.IdColonia, new SelectList(string.Empty, "Value", "Text"), "Selecciona una Colonia", new { @class = "form-control", @id = "ddlColonia" })
                                @Html.ValidationMessageFor(model => model.Direccion.Colonia.IdColonia, null, new{@class="text-danger"})
                            }
                            else
                            {
                                @Html.DropDownListFor(model => model.Direccion.Colonia.IdColonia, new SelectList(Model.Direccion.Colonia.Colonias, "IdColonia", "Nombre"), "Selecciona una Colonia", new { @class = "form-control", @id = "ddlColonia" })
                                @Html.ValidationMessageFor(model => model.Direccion.Colonia.IdColonia, null, new{@class="text-danger"})
                            }
                        </div>
                        </div>                        
                        </div>

                    <div class="row">
                            <div class="col-md-3">
                            @Html.Label("Calle")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                            @Html.TextBoxFor(model => model.Direccion.Calle, new { @class = "form-control", @id ="txtCalle"})
                            @Html.ValidationMessageFor(model => model.Direccion.Calle, null, new{@class="text-danger"})
                            </div>
                        </div>
                            <div class="col-md-3">
                            @Html.Label("Numero Interior") 
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                            @Html.TextBoxFor(model => model.Direccion.NumeroInterior, new { @class = "form-control", @id ="txtNExterior"})
                            @Html.ValidationMessageFor(model => model.Direccion.NumeroInterior, null, new{@class="text-danger"})
                            </div>
                        </div>
                        <div class="col-md-3">
                            @Html.Label("Numero Interior") 
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                            @Html.TextBoxFor(model => model.Direccion.NumeroExterior, new { @class = "form-control", @id ="txtNInterior"})
                            @Html.ValidationMessageFor(model => model.Direccion.NumeroExterior, null, new{@class="text-danger"})
                            </div>
                        </div>
                    </div>
                     <div class="row">
                         <div class="col-md-3">
                            @Html.Label("CURP")
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-people"></i></span>
                            @Html.TextBoxFor(model => model.CURP, new { @class = "form-control", @id = "txtCURP", @onkeypress ="return ValidarCURP(event,'lblCURP')"})
                            @Html.ValidationMessageFor(model => model.CURP, null, new{@class="text-danger"})
                            <label id="lblCURP"></label>
                            </div>
                            @*@Html.LabelFor(model => model.Curp)
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1"><i class="bi bi-card-heading" ></i></span>
                    @Html.TextBoxFor(model => model.Curp, new { @class = "form-control", @id = "txtCurp", @oninput="validarInput(this)"})
                </div>
                @Html.ValidationMessageFor(model => model.Curp, null, new { @class = "text-danger"})
                <label style="color:red" id="resultado"></label> *@
                        </div>
                         <div class="col-md-3">
                            @Html.Label("Rol")
                            <div class=input-group-text mb-3" >
                                <span class="input-group-text" id="basic-addon1"><i class="bi bi-journal-text" style="color: midnightblue"></i></span>
                            @Html.DropDownListFor(model => model.Rol.IdRol, new SelectList(Model.Rol.Roles, "IdRol", "Nombre"), "Selecciona un Rol", new { @class = "form-control" })
                            @Html.ValidationMessageFor(model => model.Rol.IdRol, null, new{@class="text-danger"})
                            </div>
                            </div>
                         <div class="col-md-3">
                        @Html.Label("Imagen")
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1"><i class="bi bi-card-image"></i></span>
                            <input type='file' class="form-control" name="fuImage" onchange="readURL(this);" />
                        </div>

                        @if (Model.Imagen != null)
                        {
                            <img id="Img" src="data:image/*;base64,Model.Imagen" style="width:auto ; height:100px" />
                        }
                        else
                        {
                            <img id="Img" src="~/Imagenes/sinimagen.jpg" style="width:auto ; height:100px" />
                        }
                    </div>
                    @Html.HiddenFor(model => model.Imagen)
                     <div class="col-md-3">
                            <input type="submit" value="Guardar" class="btn btn-success" />
                            @Html.ActionLink("Regresar", "GetAll", "UsuarioController", htmlAttributes: new { @class = "btn btn-danger" })
                        </div>
                    </div>
                </div>
            }
        </div>
        </div>
    </div>

@section Scripts
{

<script src="~/lib/jquery/dist/jquery.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $("#ddlPais").change(function () {
            $("#ddlEstado").empty();
            $.ajax({
                type: 'GET',
                url: '@Url.Action("EstadoGetByIdPais")',
                dataType: 'json',
                data: { IdPais: $("#ddlPais").val() },
                success: function (estados) {
                    $("#ddlEstado").append('<option value="0">'+ 'Seleccione una opción' + '</option>');
                    $.each(estados, function (i, estados) {
                        $("#ddlEstado").append('<option value="'
                                                   + estados.idEstado + '">'
                                                   + estados.nombre + '</option>'
                        );
                    });
                },  
                error: function (ex) {
                    alert('Failed.' + ex);
                }
            });
        });
    });

    $(document).ready(function () {
        $("#ddlEstado").change(function () {
            $("#ddlMunicipio").empty();
            $.ajax({
                type: 'GET',
                url: '@Url.Action("MunicipioGetByIdEstado")',
                dataType: 'json',
                data: { IdEstado: $("#ddlEstado").val() },
                success: function (municicpios) {
                    $("#ddlMunicipio").append('<option value="0">'+ 'Seleccione una opción' + '</option>');
                    $.each(municicpios, function (i, municipios) {
                        $("#ddlMunicipio").append('<option value="'
                                                   + municipios.idMunicipio + '">'
                                                   + municipios.nombre + '</option>');
                    });
                },  
                error: function (ex) {
                    alert('Failed.' + ex);
                }
            });
        });
    });

    $(document).ready(function () {
        $("#ddlMunicipio").change(function () {
            $("#ddlColonia").empty();
            $.ajax({
                type: 'GET',
                url: '@Url.Action("ColoniaGetByIdMunicipio")',
                dataType: 'json',
                data: { IdMunicipio: $("#ddlMunicipio").val() },
                success: function (colonias){
                    $("#ddlColonia").append('<option value="0">'+ 'Seleccione una opción' + '</option>');
                    $.each(colonias, function (i, colonias) {
                        $("#ddlColonia").append('<option value="'
                                                   + colonias.idColonia + '">'
                                                   + colonias.nombre + '</option>');
                    });
                },  
                error: function (ex) {
                    alert('Failed.' + ex);
                }
            });
        });
    });

    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#Img')
                  .attr('src', e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function validateFile() 
        {
            var allowedExtension = ['jpeg', 'jpg', 'png'];
            var fileExtension = document.getElementById('fuImage').value.split('.').pop().toLowerCase();
            var isValidFile = false;
                for(var index in allowedExtension) {
                    if(fileExtension === allowedExtension[index]) {
                        isValidFile = true; 
                        break;
                    }
                }
                if(!isValidFile) {
                    alert('Las extensiones permitidas son : *.' + allowedExtension.join(', *.'));
                    document.getElementById('fuImage').value = ""
                }
                return isValidFile;
        }

    function SoloLetras(e, ControlId){
        var regex = /^[a-zA-Z]+$/;
        var caracter = e.key;
        if(regex.test(caracter))
        {
             return true;
            
        }else{
            $('#' + ControlId).text("Solo se admiten letras");
            $('#' + ControlId).css({"color":"red"});
            return false;           
        }
    }

    function SoloNumeros(e, ControlId){
        var regex = /^[0-9]+$/;
        var num = e.key;
        if(regex.test(num))
        {
           return true;
        }else{
            $('#' + ControlId).text("Solo se admiten numeros");
            $('#' + ControlId).css({"color":"red"});
            return false;
        }
    }

    function ValidarCURP(e, ControlId){
        var regex = /^([A-Z&]|[a-z&]{1})([AEIOU]|[aeiou]{1})([A-Z&]|[a-z&]{1})([A-Z&]|[a-z&]{1})([0-9]{2})(0[1-9]|1[0-2])(0[1-9]|1[0-9]|2[0-9]|3[0-1])([HM]|[hm]{1})([AS|as|BC|bc|BS|bs|CC|cc|CS|cs|CH|ch|CL|cl|CM|cm|DF|df|DG|dg|GT|gt|GR|gr|HG|hg|JC|jc|MC|mc|MN|mn|MS|ms|NT|nt|NL|nl|OC|oc|PL|pl|QT|qt|QR|qr|SP|sp|SL|sl|SR|sr|TC|tc|TS|ts|TL|tl|VZ|vz|YN|yn|ZS|zs|NE|ne]{2})([^A|a|E|e|I|i|O|o|U|u]{1})([^A|a|E|e|I|i|O|o|U|u]{1})([^A|a|E|e|I|i|O|o|U|u]{1})([0-9]{2})+$/;
        var curp = e.key;
        if(!regex.test(curp)){
            return true;
        }
        else{
            $('#' + ControlId).text("Formato de CURP invalido");
            $('#' + ControlId).css({"color":"red"});
            return false;
        }
    }

//    function curpValida(curp) {
//    var re = /^([A-Z][AEIOUX][A-Z]{2}\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\d|3[01])[HM](?:AS|B[CS]|C[CLMSH]|D[FG]|G[TR]|HG|JC|M[CNS]|N[ETL]|OC|PL|Q[TR]|S[PLR]|T[CSL]|VZ|YN|ZS)[B-DF-HJ-NP-TV-Z]{3}[A-Z\d])(\d)$/,
//        validado = curp.match(re);
	
//    if (!validado)  //Coincide con el formato general?
//    {
//        return false;
//    }
//    else
//    {
//        return true;
//    }
      
//    return true; //Validado
//}


////Handler para el evento cuando cambia el input
////Lleva la CURP a mayúsculas para validarlo
//function validarInput(input) {
//    input.value = input.value.toUpperCase();
//    var curp = input.value,
//        resultado = document.getElementById("resultado"),
//        valido = "CURP no válido";
        
//    if (curpValida(curp)) { // ⬅️
// Acá se comprueba
//    	valido = "";
//        resultado.classList.add("ok");
//    } else {
//    	resultado.classList.remove("ok");
//    }
        
//    $('#resultado').text(valido);
//}

    function ValidarEmail() {
            var txtEmail = $("#txtEmail").val();

            var regex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/
            if (regex.test(txtEmail)) {
                document.getElementById("lblEmailError").innerHTML = "";
                return true;
            }
            else {
                $("#lblEmailError").css({ "color": "red" });
                $("#lblEmailError").removeAttr("class");
                document.getElementById("lblEmailError").innerHTML = "Correo invalido";
                return false;
            }
        }

      $( function() {
    $( "#txtFechaNacimiento" ).datepicker({ dateFormat: 'dd-mm-yy',
                                        changeMonth: true,
                                        changeYear: true});
  } );

    function CompararEmail(){
        var Email1 = $("#txtEmail").val();
        var Email2 = $("#txtEmail2").val();
        if(Email1 == Email2){
            document.getElementById("lblEmail").innerHTML = "";
            return true;
        }else{
            $("#lblEmail").css({ "color": "red" });
            $("#lblEmail").removeAttr("class");
            document.getElementById("lblEmail").innerHTML = "Los correos no coinciden";
            return false;
        }
    }

    function CompararPassword(){
        var Password1 = $("#txtPassword").val();
        var Password2 = $("#txtPassword2").val();
        if(Password1 == Password2){
            document.getElementById("lblPassword").innerHTML = "";
            return true;
        }else{
            $("#lblPassword").css({ "color": "red" });
            $("#lblPassword").removeAttr("class");
            document.getElementById("lblPassword").innerHTML = "Las contraseñas no coinciden";
            return false;
        }
    }
</script>
}